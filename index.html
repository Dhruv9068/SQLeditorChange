<!doctype html>
<html lang="en" class="bx--g100">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>DB2 SQL Editor</title>

    <!-- IBM Plex Mono and Carbon CSS -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;600&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://unpkg.com/carbon-components/css/carbon-components.min.css" />

    <style>
      /* Theme tokens */
      :root {
        /* Dark as default */
        --page-bg: #161616;
        --container-bg: #262626;
        --text-primary: #f4f4f4;
        --text-secondary: #c6c6c6;
        --border-color: #262626;
        --muted-bg: #262626;
        --table-header-bg: #393939;
        --table-row-bg: var(--container-bg);
        --table-row-alt-bg: #2d2d2d;
        --input-bg: #262626;
      }

      :root[data-theme="light"] {
        --page-bg: #f4f4f4;
        --container-bg: #ffffff;
        --text-primary: #161616;
        --text-secondary: #525252;
        --border-color: #e0e0e0;
        --muted-bg: #f4f4f4;
        --table-header-bg: #f4f4f4;
        --table-row-bg: #ffffff;
        --table-row-alt-bg: #f9f9f9;
        --input-bg: #ffffff;
      }

      @media (prefers-color-scheme: light) {
        :root:not([data-theme="dark"]) { 
          /* Honor system light when explicit dark not set */
          --page-bg: #f4f4f4;
          --container-bg: #ffffff;
          --text-primary: #161616;
          --text-secondary: #525252;
          --border-color: #e0e0e0;
          --muted-bg: #f4f4f4;
          --table-header-bg: #f4f4f4;
          --table-row-bg: #ffffff;
          --table-row-alt-bg: #f9f9f9;
          --input-bg: #ffffff;
        }
      }

      html, body { height: 100%; }

      body {
        margin: 0;
        background: var(--page-bg);
        color: var(--text-primary);
        font-family: 'IBM Plex Mono', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
        overflow: hidden;
      }

      .app-shell { display: flex; flex-direction: column; height: 100vh; }

      /* Top toolbar */
      .toolbar { border-bottom: 1px solid var(--border-color); background: var(--page-bg); padding: 0.5rem 2rem; }

      .editor-container { display: flex; flex-direction: column; min-height: 160px; border-bottom: 1px solid var(--border-color); }

      #sqlEditor {
        background: var(--container-bg);
        color: var(--text-primary);
        border: none;
        outline: none;
        resize: none;
        padding: 1rem 1.25rem;
        font-family: 'IBM Plex Mono', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
        font-size: 0.875rem; /* Code size */
        line-height: 1.5;
        min-height: 220px;
      }

      .resize-handle { height: 6px; background: var(--border-color); cursor: ns-resize; }

      .results-container { flex: 1; display: flex; flex-direction: column; min-height: 0; }

      .results-toolbar {
        background: var(--page-bg);
        border-bottom: 1px solid var(--border-color);
        padding: 0.5rem 2rem;
        display: flex; align-items: center; justify-content: space-between; gap: 1rem;
      }

      .results-content { flex: 1; overflow: auto; }

      .pagination-area { background: var(--page-bg); border-top: 1px solid var(--border-color); padding: 0.25rem 2rem; }

      /* Data table dark/light adjustments */
      .bx--data-table-container { background: var(--page-bg); }
      .bx--data-table { background: var(--container-bg); color: var(--text-primary); }
      .bx--data-table thead th { background: var(--table-header-bg); color: var(--text-primary); border-bottom: 1px solid var(--border-color); }
      .bx--data-table tbody td { background: var(--table-row-bg); border-top: 1px solid var(--border-color); }
      .bx--data-table--zebra tbody tr:nth-child(odd) td { background-color: var(--table-row-alt-bg); }
      .bx--data-table tbody tr:hover td { background-color: rgba(255,255,255,0.08); }

      /* Search/input styles for themes */
      .bx--search .bx--search-input { background: var(--input-bg); color: var(--text-primary); border: 1px solid var(--border-color); }
      .bx--search .bx--search-input::placeholder { color: var(--text-secondary); }
      .bx--search .bx--search-close { color: var(--text-secondary); }
    </style>
  </head>
  <body>
    <div class="app-shell">
      <!-- Unified Toolbar (path + actions) -->
      <div class="toolbar">
        <div class="bx--grid bx--grid--full-width">
          <div class="bx--row" style="align-items:center; justify-content:space-between; gap:1rem;">
            <div class="bx--col" style="min-width:0;">
              <div id="connectionPath" class="bx--type-code-01" style="color: var(--text-secondary); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Not connected</div>
            </div>

            <div class="bx--col" style="display:flex; justify-content:flex-end; gap:.5rem;">
              <!-- Save .sql only -->
              <button id="saveSqlButton" class="bx--btn bx--btn--secondary" title="Save as .sql">
                Save
                <svg focusable="false" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" fill="currentColor" width="16" height="16" viewBox="0 0 32 32" aria-hidden="true" style="margin-left:.25rem"><path d="M28 10.1l-6.1-6.1H6v24h22zM10 6h10v6H10zM26 26H8V6h2v8h14V6h1.6L28 8.4z"></path></svg>
              </button>

              <!-- Run button -->
              <button id="executeButton" class="bx--btn bx--btn--primary">
                Run
                <svg focusable="false" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" fill="currentColor" width="16" height="16" viewBox="0 0 32 32" aria-hidden="true" style="margin-left:.25rem"><path d="M10 16L22 16"></path><path d="M18 12L22 16 18 20" fill="none" stroke="currentColor" stroke-width="2"></path></svg>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Editor -->
      <div class="editor-container">
        <textarea id="sqlEditor" placeholder="SELECT * FROM table;"></textarea>
        <div class="resize-handle" id="resizeHandle"></div>
      </div>

      <!-- Results -->
      <section class="results-container">
        <div class="results-toolbar">
          <div style="display:flex; align-items:center; gap:1rem;">
            <div class="bx--search bx--search--sm" role="search">
              <div class="bx--search-magnifier" aria-hidden="true">
                <!-- Carbon Search icon (refined) -->
                <svg focusable="false" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" fill="currentColor" width="16" height="16" viewBox="0 0 32 32" aria-hidden="true">
                  <path d="M29.71 28.29l-7.4-7.4A11.93 11.93 0 1013 25.94 11.82 11.82 0 0021.6 23l7.4 7.4zM13 23A10 10 0 1123 13 10 10 0 0113 23z"></path>
                </svg>
              </div>
              <label id="searchResults-label" class="bx--label">Search results</label>
              <input class="bx--search-input" type="text" id="searchResults" role="searchbox" placeholder="Search result set" aria-labelledby="searchResults-label" />
              <button class="bx--search-close" id="searchClearBtn" title="Clear search" aria-label="Clear search"></button>
            </div>
            <div id="resultsInfo" class="bx--type-code-01" style="color: var(--text-secondary)"></div>
          </div>

          <div style="display:flex; align-items:center; gap:.5rem;">
            <div class="bx--overflow-menu" data-overflow-menu role="button" aria-haspopup="true" aria-expanded="false" tabindex="0" title="Export">
              <svg focusable="false" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" fill="currentColor" width="20" height="20" viewBox="0 0 32 32" aria-hidden="true"><path d="M26 6v20H6V6zm2-2H4v24h24zM10 22h12v2H10zm0-6h12v2H10zm0-6h12v2H10z"></path></svg>
              <ul class="bx--overflow-menu-options bx--overflow-menu--flip">
                <li class="bx--overflow-menu-options__option"><button class="bx--overflow-menu-options__btn" id="exportJsonButton"><span class="bx--overflow-menu-options__option-content">Export to JSON</span></button></li>
                <li class="bx--overflow-menu-options__option"><button class="bx--overflow-menu-options__btn" id="exportCsvButton"><span class="bx--overflow-menu-options__option-content">Export to CSV</span></button></li>
              </ul>
            </div>
          </div>
        </div>

        <div class="results-content" id="resultsContent">
          <!-- Table injected here -->
        </div>

        <div class="pagination-area">
          <div class="bx--pagination bx--pagination--inline" data-pagination id="paginationRoot">
            <div class="bx--pagination__left">
              <label id="itemsPerPageLabel" class="bx--pagination__text">Items per page:</label>
              <div class="bx--select bx--select--inline bx--pagination__control">
                <div class="bx--select-input__wrapper" style="min-width:5rem;">
                  <select class="bx--select-input" id="itemsPerPage" aria-labelledby="itemsPerPageLabel">
                    <option value="6">6</option>
                    <option value="10">10</option>
                    <option value="20">20</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                  </select>
                  <svg focusable="false" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bx--select__arrow" width="16" height="16" viewBox="0 0 32 32" aria-hidden="true"><path d="M16 22L6 12 7.4 10.6 16 19.2 24.6 10.6 26 12z"></path></svg>
                </div>
              </div>
              <span id="paginationInfo" class="bx--pagination__text">0 items</span>
            </div>
            <div class="bx--pagination__right">
              <button class="bx--btn bx--btn--icon-only bx--btn--ghost" id="prevPage" disabled aria-label="Previous page">
                <svg focusable="false" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" fill="currentColor" width="16" height="16" viewBox="0 0 32 32" aria-hidden="true"><path d="M20 24L10 16 20 8 20 24z"></path></svg>
              </button>
              <button class="bx--btn bx--btn--icon-only bx--btn--ghost" id="nextPage" disabled aria-label="Next page">
                <svg focusable="false" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" fill="currentColor" width="16" height="16" viewBox="0 0 32 32" aria-hidden="true"><path d="M12 8L22 16 12 24 12 8z"></path></svg>
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- Toast container -->
      <div id="toastArea" style="position:fixed; right:1rem; bottom:1rem; z-index:1000;"></div>
    </div>

    <!-- Carbon JS -->
    <script src="https://unpkg.com/carbon-components/scripts/carbon-components.min.js"></script>
    <script>
      (function () {
        const settings = window['carbon-components'] ? window['carbon-components'].settings : null;
        if (settings) settings.prefix = 'bx';
        if (window['carbon-components']) window['carbon-components'].init();

        const vscode = typeof acquireVsCodeApi === 'function' ? acquireVsCodeApi() : { postMessage: () => {} };

        let currentConnectionId = '';
        let lastResults = null;
        let currentPage = 1;
        let itemsPerPageValue = 6;
        let filteredRows = [];

        // DOM
        const connectionPath = document.getElementById('connectionPath');
        const sqlEditor = document.getElementById('sqlEditor');
        const executeButton = document.getElementById('executeButton');
        const saveSqlButton = document.getElementById('saveSqlButton');
        const resizeHandle = document.getElementById('resizeHandle');
        const resultsInfo = document.getElementById('resultsInfo');
        const resultsContent = document.getElementById('resultsContent');
        const exportCsvButton = document.getElementById('exportCsvButton');
        const exportJsonButton = document.getElementById('exportJsonButton');
        const searchResults = document.getElementById('searchResults');
        const searchClearBtn = document.getElementById('searchClearBtn');
        const itemsPerPage = document.getElementById('itemsPerPage');
        const paginationInfo = document.getElementById('paginationInfo');
        const prevPage = document.getElementById('prevPage');
        const nextPage = document.getElementById('nextPage');
        const toastArea = document.getElementById('toastArea');

        // Theme: follow VS Code class or system setting
        function applyPreferredTheme() {
          const isDark = document.body.classList.contains('vscode-dark') ||
            document.body.classList.contains('vscode-high-contrast') ||
            (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches);
          document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
        }
        applyPreferredTheme();
        if (window.matchMedia) {
          try { window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', applyPreferredTheme); } catch (_) {}
        }

        executeButton.addEventListener('click', executeQuery);

        document.addEventListener('keydown', (e) => {
          if (e.ctrlKey && e.key === 'Enter') { executeQuery(); e.preventDefault(); }
          if (e.ctrlKey && (e.key === 's' || e.key === 'S')) { saveQuery('.sql'); e.preventDefault(); }
        });

        // Save .sql only
        saveSqlButton.addEventListener('click', () => saveQuery('.sql'));

        // Search
        if (searchClearBtn) {
          searchClearBtn.addEventListener('click', () => {
            searchResults.value = '';
            const evt = new Event('input', { bubbles: true });
            searchResults.dispatchEvent(evt);
          });
        }
        searchResults.addEventListener('input', () => {
          if (!lastResults) return;
          const searchTerm = searchResults.value.toLowerCase();
          if (!searchTerm) {
            filteredRows = lastResults.rows;
          } else {
            filteredRows = lastResults.rows.filter((row) =>
              row.some((cell) => cell != null && String(cell).toLowerCase().includes(searchTerm))
            );
          }
          currentPage = 1;
          updateResultsTable();
        });

        // Pagination
        itemsPerPage.addEventListener('change', () => { itemsPerPageValue = parseInt(itemsPerPage.value, 10); currentPage = 1; updateResultsTable(); });
        prevPage.addEventListener('click', () => { if (currentPage > 1) { currentPage--; updateResultsTable(); } });
        nextPage.addEventListener('click', () => { const totalPages = Math.ceil(filteredRows.length / itemsPerPageValue); if (currentPage < totalPages) { currentPage++; updateResultsTable(); } });

        // Resize editor
        let startY = 0; let startHeight = 0;
        resizeHandle.addEventListener('mousedown', (e) => { startY = e.clientY; startHeight = parseInt(getComputedStyle(sqlEditor).height, 10); document.documentElement.addEventListener('mousemove', doDrag, false); document.documentElement.addEventListener('mouseup', stopDrag, false); });
        function doDrag(e) { const newHeight = startHeight + e.clientY - startY; if (newHeight > 120) sqlEditor.style.height = newHeight + 'px'; }
        function stopDrag() { document.documentElement.removeEventListener('mousemove', doDrag, false); document.documentElement.removeEventListener('mouseup', stopDrag, false); }

        // Save & Export
        function saveQuery(format) {
          const query = sqlEditor.value.trim();
          if (!query) { showToast('Nothing to save', 'error'); return; }
          vscode.postMessage({ command: 'saveQuery', content: query, format });
          showToast(`Query saved as ${format}`, 'success');
        }

        exportCsvButton.addEventListener('click', () => {
          if (!lastResults || lastResults.rowCount === 0) { showToast('No results to export', 'error'); return; }
          vscode.postMessage({ command: 'exportResults', format: 'csv' });
          showToast('Results exported to CSV', 'success');
        });
        exportJsonButton.addEventListener('click', () => {
          if (!lastResults || lastResults.rowCount === 0) { showToast('No results to export', 'error'); return; }
          vscode.postMessage({ command: 'exportResults', format: 'json' });
          showToast('Results exported to JSON', 'success');
        });

        function executeQuery() {
          const query = sqlEditor.value.trim();
          if (!query) { showToast('Please enter a SQL query', 'error'); return; }
          if (!currentConnectionId) { showToast('No active connection', 'error'); return; }
          vscode.postMessage({ command: 'executeQuery', connectionId: currentConnectionId, query });
        }

        // Host messages
        window.addEventListener('message', (event) => {
          const message = event.data || {};
          switch (message.command) {
            case 'updateConnections':
              updateConnectionList(message.connections || [], message.currentConnectionId);
              break;
            case 'setTheme':
              if (message.theme === 'light' || message.theme === 'dark') {
                document.documentElement.setAttribute('data-theme', message.theme);
              }
              break;
            case 'queryStarted':
              showLoading();
              break;
            case 'queryResults':
              showResults(message.results);
              break;
            case 'queryError':
              showError(message.error);
              break;
            case 'setEditorContent':
              sqlEditor.value = message.content || '';
              break;
          }
        });

        function updateConnectionList(connections, selectedConnectionId) {
          if (!connections || connections.length === 0) {
            currentConnectionId = '';
            executeButton.disabled = true;
            connectionPath.textContent = 'Not connected';
            return;
          }
          if (selectedConnectionId) {
            currentConnectionId = selectedConnectionId;
          } else {
            currentConnectionId = connections[0].id;
          }
          executeButton.disabled = !currentConnectionId;
          const selectedConn = connections.find((c) => c.id === currentConnectionId);
          if (selectedConn) connectionPath.textContent = `${selectedConn.name}/${selectedConn.database}`;
        }

        function showLoading() {
          resultsContent.innerHTML = `
            <div class="bx--inline-loading bx--inline-loading--active" role="status" style="padding:1.5rem;">
              <div class="bx--inline-loading__animation">
                <div data-inline-loading-spinner class="bx--loading bx--loading--small">
                  <svg class="bx--loading__svg" viewBox="-75 -75 150 150">
                    <circle cx="0" cy="0" r="37.5"></circle>
                  </svg>
                </div>
              </div>
              <p class="bx--inline-loading__text">Executing queryâ€¦</p>
            </div>`;
          resultsInfo.textContent = '';
        }

        function showResults(results) {
          lastResults = results;
          if (results.hasError) { showError(results.errorMessage); return; }
          resultsInfo.textContent = `${results.rowCount} rows in ${results.executionTime}ms`;
          filteredRows = results.rows; currentPage = 1; searchResults.value = '';
          updateResultsTable();
          showToast('Query executed successfully', 'success');
        }

        function updateResultsTable() {
          if (!lastResults || !filteredRows) return;
          const startIndex = (currentPage - 1) * itemsPerPageValue;
          const endIndex = Math.min(startIndex + itemsPerPageValue, filteredRows.length);
          const pageRows = filteredRows.slice(startIndex, endIndex);

          let html = '';
          html += '<div class="bx--data-table-container">';
          html += '<table class="bx--data-table bx--data-table--zebra"><thead><tr>';
          lastResults.columns.forEach((col) => { html += `<th><div class=\"bx--table-header-label\">${escapeHtml(col)}</div></th>`; });
          html += '</tr></thead><tbody>';
          pageRows.forEach((row) => {
            html += '<tr>';
            row.forEach((cell) => { html += `<td>${formatCell(cell)}</td>`; });
            html += '</tr>';
          });
          html += '</tbody></table></div>';
          resultsContent.innerHTML = html;

          const totalPages = Math.ceil(filteredRows.length / itemsPerPageValue) || 1;
          paginationInfo.textContent = filteredRows.length > 0 ? `${startIndex + 1}-${endIndex} of ${filteredRows.length} items` : '0 items';
          prevPage.disabled = currentPage <= 1;
          nextPage.disabled = currentPage >= totalPages;
        }

        function showError(message) {
          resultsContent.innerHTML = `<div class=\"bx--inline-notification bx--inline-notification--error\" role=\"alert\" style=\"margin:1rem;\">\n            <div class=\"bx--inline-notification__details\">\n              <div class=\"bx--inline-notification__text-wrapper\">\n                <p class=\"bx--inline-notification__title\">Query failed</p>\n                <p class=\"bx--inline-notification__subtitle\">${escapeHtml(message || 'Unknown error')}</p>\n              </div>\n            </div>\n          </div>`;
          resultsInfo.textContent = 'Error';
          showToast('Query execution failed', 'error');
        }

        function showToast(message, tone) {
          const kind = tone === 'error' ? 'error' : 'success';
          const iconPath = kind === 'error'
            ? '<path d="M16 2a14 14 0 1014 14A14.016 14.016 0 0016 2zm0 26a12 12 0 1112-12 12.013 12.013 0 01-12 12z"></path><path d="M21 22.59L17.41 19 21 15.41 19.59 14 16 17.59 12.41 14 11 15.41 14.59 19 11 22.59 12.41 24 16 20.41 19.59 24 21 22.59z"></path>'
            : '<path d="M16 2a14 14 0 1014 14A14.016 14.016 0 0016 2zm0 26a12 12 0 1112-12 12.013 12.013 0 01-12 12z"></path><path d="M14.59 21.59L10 17l1.41-1.41L14.59 18.76 20.59 12.76 22 14.17 14.59 21.59z"></path>';

          const container = document.createElement('div');
          container.className = `bx--toast-notification bx--toast-notification--${kind}`;
          container.setAttribute('role', 'status');
          container.style.marginBottom = '0.5rem';
          container.innerHTML = `
            <div class="bx--toast-notification__details">
              <svg class="bx--toast-notification__icon" viewBox="0 0 32 32" width="20" height="20" xmlns="http://www.w3.org/2000/svg" fill="currentColor" aria-hidden="true">${iconPath}</svg>
              <div class="bx--toast-notification__text-wrapper">
                <p class="bx--toast-notification__title">${kind === 'error' ? 'Error' : 'Success'}</p>
                <p class="bx--toast-notification__subtitle">${escapeHtml(message)}</p>
              </div>
            </div>`;
          toastArea.appendChild(container);
          setTimeout(() => container.remove(), 3000);
        }

        function formatCell(value) { if (value === null || value === undefined) return '<em>NULL</em>'; return escapeHtml(String(value)); }
        function escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
      })();
    </script>
  </body>
</html>
