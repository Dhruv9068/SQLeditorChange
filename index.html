<!doctype html>
<html lang="en" class="bx--g100">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>DB2 SQL Editor</title>

    <!-- IBM Plex Mono and Carbon CSS -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;600&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://unpkg.com/carbon-components/css/carbon-components.min.css" />

    <style>
      :root {
        --page-bg: #161616; /* g100 background */
        --container-bg: #262626; /* Layer background */
      }

      html, body { height: 100%; }

      body {
        margin: 0;
        background: var(--page-bg);
        color: #f4f4f4;
        font-family: 'IBM Plex Mono', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
        overflow: hidden;
      }

      .app-shell { display: flex; flex-direction: column; height: 100vh; }

      /* Header spacing uses Carbon grid but with larger x padding */
      .app-header { border-bottom: 1px solid #262626; padding: 0 2rem; }

      .toolbar { border-bottom: 1px solid #262626; background: var(--page-bg); padding: 0.5rem 2rem; }

      .editor-container { display: flex; flex-direction: column; min-height: 160px; border-bottom: 1px solid #262626; }

      #sqlEditor {
        background: var(--container-bg);
        color: #f4f4f4;
        border: none;
        outline: none;
        resize: none;
        padding: 1rem 1.25rem;
        font-family: 'IBM Plex Mono', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
        font-size: 0.875rem; /* Code size */
        line-height: 1.5;
        min-height: 220px;
      }

      .resize-handle { height: 6px; background: #262626; cursor: ns-resize; }

      .results-container { flex: 1; display: flex; flex-direction: column; min-height: 0; }

      .results-toolbar {
        background: var(--page-bg);
        border-bottom: 1px solid #262626;
        padding: 0.5rem 2rem;
        display: flex; align-items: center; justify-content: space-between; gap: 1rem;
      }

      .results-content { flex: 1; overflow: auto; }

      .pagination-area { background: var(--page-bg); border-top: 1px solid #262626; padding: 0.25rem 2rem; }

      .bx--data-table-container { background: var(--page-bg); }
    </style>
  </head>
  <body>
    <div class="app-shell">
      <!-- Header -->
      <header class="app-header">
        <div class="bx--grid bx--grid--full-width">
          <div class="bx--row" style="padding: .75rem 0; align-items:center;">
            <div class="bx--col">
              <div class="bx--type-productive-heading-01" style="color:#c6c6c6;">Database</div>
              <div id="connectionPath" class="bx--type-code-01" style="color:#f4f4f4;">Not connected</div>
            </div>
          </div>
        </div>
      </header>

      <!-- Toolbar -->
      <div class="toolbar">
        <div class="bx--grid bx--grid--full-width">
          <div class="bx--row" style="align-items:center; gap:1rem;">
            <div class="bx--col-lg-8 bx--col-md-6 bx--col-sm-4">
              <div class="bx--form-item">
                <label for="connectionSelector" class="bx--label bx--type-code-01">Connection</label>
                <div class="bx--select bx--select--inline" style="width:100%; max-width: 560px;">
                  <label for="connectionSelector" class="bx--label">Select</label>
                  <div class="bx--select-input__wrapper">
                    <select id="connectionSelector" class="bx--select-input">
                      <option value="">Select a connectionâ€¦</option>
                    </select>
                    <svg focusable="false" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bx--select__arrow" width="16" height="16" viewBox="0 0 32 32" aria-hidden="true"><path d="M16 22L6 12 7.4 10.6 16 19.2 24.6 10.6 26 12z"></path></svg>
                  </div>
                </div>
              </div>
            </div>

            <div class="bx--col" style="display:flex; justify-content:flex-end; gap:.5rem;">
              <!-- Save overflow menu -->
              <div class="bx--overflow-menu" data-overflow-menu role="button" aria-haspopup="true" aria-expanded="false" tabindex="0" title="Save">
                <svg focusable="false" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" fill="currentColor" aria-label="Save menu" width="20" height="20" viewBox="0 0 32 32"><path d="M28 10.1l-6.1-6.1h-15.9v24h22zM10 6h10v6h-10zM26 26h-20v-20h2v8h14v-8h1.6l2.4 2.4z"></path></svg>
                <ul class="bx--overflow-menu-options bx--overflow-menu--flip">
                  <li class="bx--overflow-menu-options__option">
                    <button class="bx--overflow-menu-options__btn" id="saveDdl" title="Save as .ddl"><span class="bx--overflow-menu-options__option-content">Save as .ddl</span></button>
                  </li>
                  <li class="bx--overflow-menu-options__option">
                    <button class="bx--overflow-menu-options__btn" id="saveDb2Ddl" title="Save as .db2.ddl"><span class="bx--overflow-menu-options__option-content">Save as .db2.ddl</span></button>
                  </li>
                  <li class="bx--overflow-menu-options__option">
                    <button class="bx--overflow-menu-options__btn" id="saveSql" title="Save as .sql"><span class="bx--overflow-menu-options__option-content">Save as .sql</span></button>
                  </li>
                  <li class="bx--overflow-menu-options__option">
                    <button class="bx--overflow-menu-options__btn" id="saveDb2Sql" title="Save as .db2.sql"><span class="bx--overflow-menu-options__option-content">Save as .db2.sql</span></button>
                  </li>
                </ul>
              </div>

              <!-- Run button -->
              <button id="executeButton" class="bx--btn bx--btn--primary">
                Run
                <svg focusable="false" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" fill="currentColor" width="16" height="16" viewBox="0 0 32 32" aria-hidden="true" style="margin-left:.25rem"><path d="M10 16L22 16"></path><path d="M18 12L22 16 18 20" fill="none" stroke="currentColor" stroke-width="2"></path></svg>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Editor -->
      <div class="editor-container">
        <textarea id="sqlEditor" placeholder="SELECT * FROM table;"></textarea>
        <div class="resize-handle" id="resizeHandle"></div>
      </div>

      <!-- Results -->
      <section class="results-container">
        <div class="results-toolbar">
          <div style="display:flex; align-items:center; gap:1rem;">
            <div class="bx--search bx--search--sm" role="search">
              <div class="bx--search-magnifier" aria-hidden="true">
                <svg focusable="false" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" fill="currentColor" width="16" height="16" viewBox="0 0 32 32" aria-hidden="true"><path d="M29.71 28.29l-6.94-6.94A11.91 11.91 0 1024 24.77l6.94 6.94zM13 22a9 9 0 119-9A9 9 0 0113 22z"></path></svg>
              </div>
              <label id="searchResults-label" class="bx--label">Search results</label>
              <input class="bx--search-input" type="text" id="searchResults" role="searchbox" placeholder="Search result set" aria-labelledby="searchResults-label" />
              <button class="bx--search-close" id="searchClearBtn" title="Clear search" aria-label="Clear search"></button>
            </div>
            <div id="resultsInfo" class="bx--type-code-01" style="color:#c6c6c6"></div>
          </div>

          <div style="display:flex; align-items:center; gap:.5rem;">
            <div class="bx--overflow-menu" data-overflow-menu role="button" aria-haspopup="true" aria-expanded="false" tabindex="0" title="Export">
              <svg focusable="false" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" fill="currentColor" width="20" height="20" viewBox="0 0 32 32" aria-hidden="true"><path d="M26 6v20H6V6zm2-2H4v24h24zM10 22h12v2H10zm0-6h12v2H10zm0-6h12v2H10z"></path></svg>
              <ul class="bx--overflow-menu-options bx--overflow-menu--flip">
                <li class="bx--overflow-menu-options__option"><button class="bx--overflow-menu-options__btn" id="exportJsonButton"><span class="bx--overflow-menu-options__option-content">Export to JSON</span></button></li>
                <li class="bx--overflow-menu-options__option"><button class="bx--overflow-menu-options__btn" id="exportCsvButton"><span class="bx--overflow-menu-options__option-content">Export to CSV</span></button></li>
              </ul>
            </div>
          </div>
        </div>

        <div class="results-content" id="resultsContent">
          <!-- Table injected here -->
        </div>

        <div class="pagination-area">
          <div class="bx--pagination bx--pagination--inline" data-pagination id="paginationRoot">
            <div class="bx--pagination__left">
              <label id="itemsPerPageLabel" class="bx--pagination__text">Items per page:</label>
              <div class="bx--select bx--select--inline bx--pagination__control">
                <div class="bx--select-input__wrapper" style="min-width:5rem;">
                  <select class="bx--select-input" id="itemsPerPage" aria-labelledby="itemsPerPageLabel">
                    <option value="6">6</option>
                    <option value="10">10</option>
                    <option value="20">20</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                  </select>
                  <svg focusable="false" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bx--select__arrow" width="16" height="16" viewBox="0 0 32 32" aria-hidden="true"><path d="M16 22L6 12 7.4 10.6 16 19.2 24.6 10.6 26 12z"></path></svg>
                </div>
              </div>
              <span id="paginationInfo" class="bx--pagination__text">0 items</span>
            </div>
            <div class="bx--pagination__right">
              <button class="bx--btn bx--btn--icon-only bx--btn--ghost" id="prevPage" disabled aria-label="Previous page">
                <svg focusable="false" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" fill="currentColor" width="16" height="16" viewBox="0 0 32 32" aria-hidden="true"><path d="M20 24L10 16 20 8 20 24z"></path></svg>
              </button>
              <button class="bx--btn bx--btn--icon-only bx--btn--ghost" id="nextPage" disabled aria-label="Next page">
                <svg focusable="false" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" fill="currentColor" width="16" height="16" viewBox="0 0 32 32" aria-hidden="true"><path d="M12 8L22 16 12 24 12 8z"></path></svg>
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- Toast container -->
      <div id="toastArea" style="position:fixed; right:1rem; bottom:1rem; z-index:1000;"></div>
    </div>

    <!-- Carbon JS -->
    <script src="https://unpkg.com/carbon-components/scripts/carbon-components.min.js"></script>
    <script>
      (function () {
        const settings = window['carbon-components'] ? window['carbon-components'].settings : null;
        if (settings) settings.prefix = 'bx';
        if (window['carbon-components']) window['carbon-components'].init();

        const vscode = typeof acquireVsCodeApi === 'function' ? acquireVsCodeApi() : { postMessage: () => {} };

        let currentConnectionId = '';
        let lastResults = null;
        let currentPage = 1;
        let itemsPerPageValue = 6;
        let filteredRows = [];

        // DOM
        const connectionSelector = document.getElementById('connectionSelector');
        const connectionPath = document.getElementById('connectionPath');
        const sqlEditor = document.getElementById('sqlEditor');
        const executeButton = document.getElementById('executeButton');
        const resizeHandle = document.getElementById('resizeHandle');
        const resultsInfo = document.getElementById('resultsInfo');
        const resultsContent = document.getElementById('resultsContent');
        const exportCsvButton = document.getElementById('exportCsvButton');
        const exportJsonButton = document.getElementById('exportJsonButton');
        const searchResults = document.getElementById('searchResults');
        const searchClearBtn = document.getElementById('searchClearBtn');
        const itemsPerPage = document.getElementById('itemsPerPage');
        const paginationInfo = document.getElementById('paginationInfo');
        const prevPage = document.getElementById('prevPage');
        const nextPage = document.getElementById('nextPage');
        const toastArea = document.getElementById('toastArea');

        // Save menu items
        const saveDdl = document.getElementById('saveDdl');
        const saveDb2Ddl = document.getElementById('saveDb2Ddl');
        const saveSql = document.getElementById('saveSql');
        const saveDb2Sql = document.getElementById('saveDb2Sql');

        connectionSelector.addEventListener('change', () => {
          currentConnectionId = connectionSelector.value;
          vscode.postMessage({ command: 'changeConnection', connectionId: currentConnectionId });
          executeButton.disabled = !currentConnectionId;
          const option = connectionSelector.options[connectionSelector.selectedIndex];
          if (option && option.value) {
            const connText = option.textContent || '';
            const dbMatch = connText.match(/\(([^@]+)@/);
            const nameMatch = connText.match(/^([^()]+)/);
            if (dbMatch && dbMatch[1] && nameMatch && nameMatch[1]) {
              const dbName = dbMatch[1];
              const connName = nameMatch[1].trim();
              connectionPath.textContent = `${connName}/${dbName}`;
            } else {
              connectionPath.textContent = 'Not connected';
            }
          } else {
            connectionPath.textContent = 'Not connected';
          }
        });

        executeButton.addEventListener('click', executeQuery);

        document.addEventListener('keydown', (e) => {
          if (e.ctrlKey && e.key === 'Enter') { executeQuery(); e.preventDefault(); }
          if (e.ctrlKey && (e.key === 's' || e.key === 'S')) { saveQuery('.sql'); e.preventDefault(); }
        });

        // Search
        if (searchClearBtn) {
          searchClearBtn.addEventListener('click', () => {
            searchResults.value = '';
            const evt = new Event('input', { bubbles: true });
            searchResults.dispatchEvent(evt);
          });
        }
        searchResults.addEventListener('input', () => {
          if (!lastResults) return;
          const searchTerm = searchResults.value.toLowerCase();
          if (!searchTerm) {
            filteredRows = lastResults.rows;
          } else {
            filteredRows = lastResults.rows.filter((row) =>
              row.some((cell) => cell != null && String(cell).toLowerCase().includes(searchTerm))
            );
          }
          currentPage = 1;
          updateResultsTable();
        });

        // Pagination
        itemsPerPage.addEventListener('change', () => { itemsPerPageValue = parseInt(itemsPerPage.value, 10); currentPage = 1; updateResultsTable(); });
        prevPage.addEventListener('click', () => { if (currentPage > 1) { currentPage--; updateResultsTable(); } });
        nextPage.addEventListener('click', () => { const totalPages = Math.ceil(filteredRows.length / itemsPerPageValue); if (currentPage < totalPages) { currentPage++; updateResultsTable(); } });

        // Resize editor
        let startY = 0; let startHeight = 0;
        resizeHandle.addEventListener('mousedown', (e) => { startY = e.clientY; startHeight = parseInt(getComputedStyle(sqlEditor).height, 10); document.documentElement.addEventListener('mousemove', doDrag, false); document.documentElement.addEventListener('mouseup', stopDrag, false); });
        function doDrag(e) { const newHeight = startHeight + e.clientY - startY; if (newHeight > 120) sqlEditor.style.height = newHeight + 'px'; }
        function stopDrag() { document.documentElement.removeEventListener('mousemove', doDrag, false); document.documentElement.removeEventListener('mouseup', stopDrag, false); }

        // Save & Export
        function saveQuery(format) {
          const query = sqlEditor.value.trim();
          if (!query) { showToast('Nothing to save', 'error'); return; }
          vscode.postMessage({ command: 'saveQuery', content: query, format });
          showToast(`Query saved as ${format}`, 'success');
        }
        saveDdl.addEventListener('click', () => saveQuery('.ddl'));
        saveDb2Ddl.addEventListener('click', () => saveQuery('.db2.ddl'));
        saveSql.addEventListener('click', () => saveQuery('.sql'));
        saveDb2Sql.addEventListener('click', () => saveQuery('.db2.sql'));

        exportCsvButton.addEventListener('click', () => {
          if (!lastResults || lastResults.rowCount === 0) { showToast('No results to export', 'error'); return; }
          vscode.postMessage({ command: 'exportResults', format: 'csv' });
          showToast('Results exported to CSV', 'success');
        });
        exportJsonButton.addEventListener('click', () => {
          if (!lastResults || lastResults.rowCount === 0) { showToast('No results to export', 'error'); return; }
          vscode.postMessage({ command: 'exportResults', format: 'json' });
          showToast('Results exported to JSON', 'success');
        });

        function executeQuery() {
          const query = sqlEditor.value.trim();
          if (!query) { showToast('Please enter a SQL query', 'error'); return; }
          if (!currentConnectionId) { showToast('Please select a connection', 'error'); return; }
          vscode.postMessage({ command: 'executeQuery', connectionId: currentConnectionId, query });
        }

        // Host messages
        window.addEventListener('message', (event) => {
          const message = event.data || {};
          switch (message.command) {
            case 'updateConnections':
              updateConnectionList(message.connections || [], message.currentConnectionId);
              break;
            case 'queryStarted':
              showLoading();
              break;
            case 'queryResults':
              showResults(message.results);
              break;
            case 'queryError':
              showError(message.error);
              break;
            case 'setEditorContent':
              sqlEditor.value = message.content || '';
              break;
          }
        });

        function updateConnectionList(connections, selectedConnectionId) {
          while (connectionSelector.options.length > 0) connectionSelector.remove(0);
          if (!connections || connections.length === 0) {
            const option = document.createElement('option'); option.value = ''; option.textContent = 'No active connections'; option.disabled = true; connectionSelector.appendChild(option);
            executeButton.disabled = true; connectionPath.textContent = 'Not connected'; return;
          }
          connections.forEach((conn) => {
            const option = document.createElement('option'); option.value = conn.id; option.textContent = `${conn.name} (${conn.database}@${conn.host})`; connectionSelector.appendChild(option);
          });
          if (selectedConnectionId) { connectionSelector.value = selectedConnectionId; currentConnectionId = selectedConnectionId; }
          else if (connections.length > 0) { connectionSelector.value = connections[0].id; currentConnectionId = connections[0].id; }
          executeButton.disabled = !currentConnectionId;
          if (currentConnectionId) {
            const selectedConn = connections.find((c) => c.id === currentConnectionId);
            if (selectedConn) connectionPath.textContent = `${selectedConn.name}/${selectedConn.database}`;
          }
        }

        function showLoading() {
          resultsContent.innerHTML = `
            <div class="bx--inline-loading bx--inline-loading--active" role="status" style="padding:1.5rem;">
              <div class="bx--inline-loading__animation">
                <div data-inline-loading-spinner class="bx--loading bx--loading--small">
                  <svg class="bx--loading__svg" viewBox="-75 -75 150 150">
                    <circle cx="0" cy="0" r="37.5"></circle>
                  </svg>
                </div>
              </div>
              <p class="bx--inline-loading__text">Executing queryâ€¦</p>
            </div>`;
          resultsInfo.textContent = '';
        }

        function showResults(results) {
          lastResults = results;
          if (results.hasError) { showError(results.errorMessage); return; }
          resultsInfo.textContent = `${results.rowCount} rows in ${results.executionTime}ms`;
          filteredRows = results.rows; currentPage = 1; searchResults.value = '';
          updateResultsTable();
          showToast('Query executed successfully', 'success');
        }

        function updateResultsTable() {
          if (!lastResults || !filteredRows) return;
          const startIndex = (currentPage - 1) * itemsPerPageValue;
          const endIndex = Math.min(startIndex + itemsPerPageValue, filteredRows.length);
          const pageRows = filteredRows.slice(startIndex, endIndex);

          let html = '';
          html += '<div class="bx--data-table-container">';
          html += '<table class="bx--data-table bx--data-table--zebra"><thead><tr>';
          lastResults.columns.forEach((col) => { html += `<th><div class=\"bx--table-header-label\">${escapeHtml(col)}</div></th>`; });
          html += '</tr></thead><tbody>';
          pageRows.forEach((row) => {
            html += '<tr>';
            row.forEach((cell) => { html += `<td>${formatCell(cell)}</td>`; });
            html += '</tr>';
          });
          html += '</tbody></table></div>';
          resultsContent.innerHTML = html;

          const totalPages = Math.ceil(filteredRows.length / itemsPerPageValue) || 1;
          paginationInfo.textContent = filteredRows.length > 0 ? `${startIndex + 1}-${endIndex} of ${filteredRows.length} items` : '0 items';
          prevPage.disabled = currentPage <= 1;
          nextPage.disabled = currentPage >= totalPages;
        }

        function showError(message) {
          resultsContent.innerHTML = `<div class=\"bx--inline-notification bx--inline-notification--error\" role=\"alert\" style=\"margin:1rem;\">\n            <div class=\"bx--inline-notification__details\">\n              <div class=\"bx--inline-notification__text-wrapper\">\n                <p class=\"bx--inline-notification__title\">Query failed</p>\n                <p class=\"bx--inline-notification__subtitle\">${escapeHtml(message || 'Unknown error')}</p>\n              </div>\n            </div>\n          </div>`;
          resultsInfo.textContent = 'Error';
          showToast('Query execution failed', 'error');
        }

        function showToast(message, tone) {
          const kind = tone === 'error' ? 'error' : 'success';
          const iconPath = kind === 'error'
            ? '<path d="M16 2a14 14 0 1014 14A14.016 14.016 0 0016 2zm0 26a12 12 0 1112-12 12.013 12.013 0 01-12 12z"></path><path d="M21 22.59L17.41 19 21 15.41 19.59 14 16 17.59 12.41 14 11 15.41 14.59 19 11 22.59 12.41 24 16 20.41 19.59 24 21 22.59z"></path>'
            : '<path d="M16 2a14 14 0 1014 14A14.016 14.016 0 0016 2zm0 26a12 12 0 1112-12 12.013 12.013 0 01-12 12z"></path><path d="M14.59 21.59L10 17l1.41-1.41L14.59 18.76 20.59 12.76 22 14.17 14.59 21.59z"></path>';

          const container = document.createElement('div');
          container.className = `bx--toast-notification bx--toast-notification--${kind}`;
          container.setAttribute('role', 'status');
          container.style.marginBottom = '0.5rem';
          container.innerHTML = `
            <div class="bx--toast-notification__details">
              <svg class="bx--toast-notification__icon" viewBox="0 0 32 32" width="20" height="20" xmlns="http://www.w3.org/2000/svg" fill="currentColor" aria-hidden="true">${iconPath}</svg>
              <div class="bx--toast-notification__text-wrapper">
                <p class="bx--toast-notification__title">${kind === 'error' ? 'Error' : 'Success'}</p>
                <p class="bx--toast-notification__subtitle">${escapeHtml(message)}</p>
              </div>
            </div>`;
          toastArea.appendChild(container);
          setTimeout(() => container.remove(), 3000);
        }

        function formatCell(value) { if (value === null || value === undefined) return '<em>NULL</em>'; return escapeHtml(String(value)); }
        function escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
      })();
    </script>
  </body>
</html>
